{
  "metadata": {
    "title": "FreeRTOS运动控制循环的状态机流程",
    "summary": "引导标定、已标定空闲循环、LoRa/蓝牙指令处理、开启/关闭控制、失速检测与电源管理的流程图。",
    "language": "zh"
  },
  "entry_node": "start",
  "nodes": [
    {
      "id": "start",
      "title": "启动与系统引导",
      "summary": "系统启动并开始初始化与标定持久化。",
      "detail": null,
      "type": "start"
    },
    {
      "id": "boot_init",
      "title": "初始化闪存存储并恢复标定",
      "summary": "初始化闪存存储并读取最近已知标定：diff_sumup 和 check_flag。",
      "detail": "如果 check_flag 为 true，则标定视为完成；否则将进入未标定路径。",
      "type": "process"
    },
    {
      "id": "calibrated_at_boot?",
      "title": "启动时已完成标定？",
      "summary": "决策：标定是否完成（check_flag == true）？",
      "detail": "若已标定，则在空闲状态启动；若未标定，则进入未标定路径。",
      "type": "decision"
    },
    {
      "id": "uncalibrated_loop",
      "title": "未标定：等待 LoRa Auto_Check",
      "summary": "等待 LoRa 帧以启动 Auto_Check 标定/限值。",
      "detail": "Auto_Check 在成功时将把 check_flag 设为 true。",
      "type": "process"
    },
    {
      "id": "auto_check",
      "title": "Auto_Check（标定/极限过程）",
      "summary": "运行标定以确定 diff_sumup 和极限值；成功时设置 check_flag。",
      "detail": "diff_sumup 将成为总开角；check_flag 将为 true。",
      "type": "call"
    },
    {
      "id": "calibrated_idle",
      "title": "已标定的空闲",
      "summary": "标定完成；监视空闲、运动指令，并保持供电。",
      "detail": "标定后的主运行时状态。",
      "type": "process"
    },
    {
      "id": "idle_timeout?",
      "title": "空闲超时检查",
      "summary": "若超过 15 秒保持空闲，则检查偏航角以决定进入低功耗或强制关闭。",
      "detail": "若 |yaw| < 10 度，进入低功耗；否则强制关闭。",
      "type": "decision"
    },
    {
      "id": "low_power_seq",
      "title": "进入低功耗序列",
      "summary": "降低电机功率、外设并使子系统进入睡眠以节省电力。",
      "detail": "包括蓝牙断连、IMU 休眠、雷达休眠，以及等待偏航角重置。",
      "type": "process"
    },
    {
      "id": "force_close_idle",
      "title": "因空闲而强制关闭",
      "summary": "将 motor_runing_flag_r 设为 1，以在长时间空闲且偏航角不接近零时开始关闭。",
      "detail": "开启关闭运动路径。",
      "type": "process"
    },
    {
      "id": "lora_parser",
      "title": "LoRa 指令解析器（AA..）",
      "summary": "解析 LoRa 帧以获取控制指令。",
      "detail": "AA00 维持电源；AAxy 设置速度/角度；AAOF 请求在开启后关闭；AARE 重新进入标定。",
      "type": "io"
    },
    {
      "id": "aa00_power_on",
      "title": "AA00：保持电机供电",
      "summary": "开启电机供电并设置 aa00_motor_enabled。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "aaxy_command",
      "title": "AAxy：设置运动/目标",
      "summary": "设置 Speed_Level_Lora 和 Angle_Level_Lora；开始开启。",
      "detail": "同时置位标志以开始开启并为定时运动做准备。",
      "type": "process"
    },
    {
      "id": "aaof_command",
      "title": "AAOF：在开启后请求关闭",
      "summary": "设置 close_flag 以便在开启循环结束后进行关闭。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "aare_command",
      "title": "AARE：重新进入标定",
      "summary": "将 check_flag 重置，以在下一次循环强制进入未标定路径。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "pb6_trigger",
      "title": "PB6 手动触发",
      "summary": "检测 PB6 边沿以在无运动时启动开启。",
      "detail": "去抖动后的边沿会使一个小计数器增加，并在准备就绪时触发开启。",
      "type": "io"
    },
    {
      "id": "opening_entry",
      "title": "开启：进入条件",
      "summary": "根据指令/触发条件确定是否应开始开启。",
      "detail": "条件包括 commandExecuted、ahead_flag，或 motor_runing_flag 已设定。",
      "type": "decision"
    },
    {
      "id": "opening_init",
      "title": "开启初始化",
      "summary": "上电、重置累加器，并为开启启用速度控制。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "opening_control",
      "title": "开启控制（运动循环）",
      "summary": "根据偏航误差计算速度并发送电机驱动指令。",
      "detail": "使用阈值、偏航角和速度上限的循环控制。",
      "type": "loop"
    },
    {
      "id": "opening_stop?",
      "title": "开启停止条件",
      "summary": "检查是否达到目标、接近阈值或检测到失速。",
      "detail": "若停止，执行停止动作；否则继续运动循环。",
      "type": "decision"
    },
    {
      "id": "opening_stop_action",
      "title": "开启停止动作",
      "summary": "停止 RPM、断电、清除标志；如有需要，排队进入关闭。",
      "detail": "若 close_flag 已设，准备进入关闭路径。",
      "type": "process"
    },
    {
      "id": "closing_entry",
      "title": "关闭：进入条件",
      "summary": "确定是否应开始关闭（关闭指令或拉动辅助）。",
      "detail": "要求偏航角远离零且运动标志已设。",
      "type": "decision"
    },
    {
      "id": "closing_init",
      "title": "关闭初始化",
      "summary": "上电、重置并为关闭启用速度控制。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "closing_control",
      "title": "关闭控制（运动循环）",
      "summary": "驱动至零角度；偏向关闭；限制速度。",
      "detail": null,
      "type": "loop"
    },
    {
      "id": "closing_stop?",
      "title": "关闭停止条件",
      "summary": "检查是否接近零偏航、超调、失速，或被开启中断。",
      "detail": "若停止，执行后处理动作；否则继续循环。",
      "type": "decision"
    },
    {
      "id": "closing_stop_action",
      "title": "关闭停止动作",
      "summary": "处理关闭后的行为，可能包含低功耗序列。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "yaw_stall_opening",
      "title": "偏航失速检查（开启）",
      "summary": "在开启过程中检测失速或方向错误的移动。",
      "detail": "检测到失速时用于安全停止。",
      "type": "decision"
    },
    {
      "id": "yaw_stall_closing",
      "title": "偏航失速检查（关闭）",
      "summary": "在关闭过程中检测失速或碰撞。",
      "detail": "用于安全停止和错误处理。",
      "type": "decision"
    },
    {
      "id": "post_move_low_power",
      "title": "移动后进入低功耗",
      "summary": "在移动完成后应用低功耗序列。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "end",
      "title": "流程结束",
      "summary": "结束节点；表示所建模序列的完成。",
      "detail": null,
      "type": "end"
    }
  ],
  "edges": [
    {
      "source": "start",
      "target": "boot_init",
      "label": "启动"
    },
    {
      "source": "boot_init",
      "target": "calibrated_at_boot?",
      "label": "读取并恢复标定（diff_sumup、check_flag）"
    },
    {
      "source": "calibrated_at_boot?",
      "target": "calibrated_idle",
      "label": "check_flag 为 true"
    },
    {
      "source": "calibrated_at_boot?",
      "target": "uncalibrated_loop",
      "label": "check_flag 为 false"
    },
    {
      "source": "uncalibrated_loop",
      "target": "auto_check",
      "label": "lora_rx_flag 为 1"
    },
    {
      "source": "auto_check",
      "target": "calibrated_at_boot?",
      "label": "成功 / check_flag 为 true"
    },
    {
      "source": "calibrated_idle",
      "target": "idle_timeout?",
      "label": "每个循环周期"
    },
    {
      "source": "idle_timeout?",
      "target": "low_power_seq",
      "label": "空闲超时且 |yaw| < 10 度"
    },
    {
      "source": "idle_timeout?",
      "target": "force_close_idle",
      "label": "空闲超时且 |yaw| >= 10 度"
    },
    {
      "source": "low_power_seq",
      "target": "calibrated_idle",
      "label": "完成低功耗唤醒/休眠"
    },
    {
      "source": "force_close_idle",
      "target": "opening_entry",
      "label": "通过空闲抢占开始关闭"
    },
    {
      "source": "calibrated_idle",
      "target": "lora_parser",
      "label": "循环迭代：轮询输入"
    },
    {
      "source": "lora_parser",
      "target": "aa00_power_on",
      "label": "AA00"
    },
    {
      "source": "lora_parser",
      "target": "aaxy_command",
      "label": "AAxy"
    },
    {
      "source": "lora_parser",
      "target": "aaof_command",
      "label": "AAOF"
    },
    {
      "source": "lora_parser",
      "target": "aare_command",
      "label": "AARE"
    },
    {
      "source": "aa00_power_on",
      "target": "calibrated_idle",
      "label": "上电后返回空闲状态"
    },
    {
      "source": "aaxy_command",
      "target": "opening_entry",
      "label": "开始开启（commandExecuted）"
    },
    {
      "source": "aaof_command",
      "target": "closing_entry",
      "label": "设置 close_flag"
    },
    {
      "source": "aare_command",
      "target": "uncalibrated_loop",
      "label": "重新进入标定"
    },
    {
      "source": "pb6_trigger",
      "target": "opening_entry",
      "label": "PB6 边沿检测且清除空闲"
    },
    {
      "source": "opening_entry",
      "target": "opening_init",
      "label": "进入条件满足"
    },
    {
      "source": "opening_init",
      "target": "opening_control",
      "label": "初始化开启运动"
    },
    {
      "source": "opening_control",
      "target": "yaw_stall_opening",
      "label": "每个控制循环"
    },
    {
      "source": "yaw_stall_opening",
      "target": "opening_stop_action",
      "label": "检测到失速"
    },
    {
      "source": "yaw_stall_opening",
      "target": "opening_control",
      "label": "无失速"
    },
    {
      "source": "opening_stop_action",
      "target": "closing_entry",
      "label": "close_flag 为 true"
    },
    {
      "source": "opening_stop_action",
      "target": "post_move_low_power",
      "label": "无 close_flag；开启后进入低功耗"
    },
    {
      "source": "closing_entry",
      "target": "closing_init",
      "label": "进入条件满足"
    },
    {
      "source": "closing_init",
      "target": "closing_control",
      "label": "初始化关闭运动"
    },
    {
      "source": "closing_control",
      "target": "yaw_stall_closing",
      "label": "每个控制循环"
    },
    {
      "source": "yaw_stall_closing",
      "target": "closing_stop_action",
      "label": "检测到失速"
    },
    {
      "source": "yaw_stall_closing",
      "target": "closing_control",
      "label": "无失速"
    },
    {
      "source": "closing_stop_action",
      "target": "post_move_low_power",
      "label": "正常停止；进入低功耗"
    },
    {
      "source": "yaw_stall_opening",
      "target": "opening_stop_action",
      "label": "因失速而紧急停止"
    },
    {
      "source": "post_move_low_power",
      "target": "calibrated_idle",
      "label": "低功耗序列完成；返回空闲"
    },
    {
      "source": "start",
      "target": "end",
      "label": "建模序列结束"
    }
  ]
}