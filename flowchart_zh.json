{
  "metadata": {
    "title": "电动机构控制循环图（嵌入式系统）",
    "summary": "主控制循环的结构化流程图：初始化、标定处理、输入（LoRa、蓝牙、IMU、GPIO）、运动控制（开启/关闭）、堵转保护、功率管理和数据持久化。",
    "language": "zh"
  },
  "entry_node": "N1",
  "nodes": [
    {
      "id": "N1",
      "title": "上电与恢复",
      "summary": "系统启动，初始化硬件，并恢复到已知状态。",
      "detail": null,
      "type": "start"
    },
    {
      "id": "N2",
      "title": "初始化外设并停止电机",
      "summary": "设置传感器/输入输出，确保电机处于空闲状态，并为操作做好准备。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N3",
      "title": "从闪存读取标定数据",
      "summary": "从闪存存储中加载 diff_sumup 和 check_flag。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N4",
      "title": "标定存在性检查",
      "summary": "系统是否已标定（check_flag 为 true）？",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N6",
      "title": "等待 LoRa 帧以进行 Auto_Check",
      "summary": "如果未标定，等待 LoRa 帧来触发 Auto_Check。",
      "detail": null,
      "type": "loop"
    },
    {
      "id": "N7",
      "title": "Auto_Check 标定",
      "summary": "执行 Auto_Check 以确定极限与最大偏航角（diff_sumup）。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N8",
      "title": "进入正常操作循环",
      "summary": "用于正常操作的主 10 ms 控制循环。",
      "detail": null,
      "type": "loop"
    },
    {
      "id": "N9",
      "title": "蓝牙指令解析",
      "summary": "来自 XY_MB06BA 设备的指令解析。",
      "detail": null,
      "type": "call"
    },
    {
      "id": "N10",
      "title": "LoRa 帧解析",
      "summary": "处理传入的 LoRa 帧并更新 lora_rx_buf。",
      "detail": null,
      "type": "call"
    },
    {
      "id": "N11",
      "title": "LoRa/命令处理",
      "summary": "处理 AA00、AAxy、AAOF 和 AARE 命令类型。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N12",
      "title": "IMU/偏航更新",
      "summary": "来自 IMU 传感器的偏航角和运动反馈更新。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N13",
      "title": "总线电流读取",
      "summary": "读取电机总线电流以进行安全/诊断。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N14",
      "title": "外部标志与手动输入检查",
      "summary": "读取 ahead_flag、back_flag 和 PB6 边沿信号。",
      "detail": null,
      "type": "io"
    },
    {
      "id": "N15",
      "title": "AA00 电源保持激活？",
      "summary": "决策：AA00 电源保持状态当前是否处于激活？",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N16",
      "title": "AA00 激活时维持电机功率",
      "summary": "在 AA00 启动运动或维持电力时保持电机供电。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N17",
      "title": "开启运动决策",
      "summary": "是否应根据命令/标志立即开启？",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N18",
      "title": "开启开合动作循环",
      "summary": "驱动打开直到满足停止条件的打开运动循环。",
      "detail": null,
      "type": "loop"
    },
    {
      "id": "N19",
      "title": "打开动作初始化",
      "summary": "为打开准备：启用电机供电、重置计时器，并切换到打开的速度模式。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N20",
      "title": "打开目标阈值计算",
      "summary": "基于 diff_sumup 和角度等级计算目标偏航阈值。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N21",
      "title": "开启速度指令计算",
      "summary": "speed = Motor_P * (threshold - yaw)，并限制在安全范围内。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N22",
      "title": "打开停止条件检查",
      "summary": "根据目标、过冲或堵转评估是否应停止打开。",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N23",
      "title": "打开停止动作",
      "summary": "停止电机，清除标志；如果设置了 AAOF，可能排队进行关闭。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N24",
      "title": "AAOF 触发关闭",
      "summary": "如果请求了 AAOF，在完成开启后准备关闭。",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N25",
      "title": "开始关闭运动",
      "summary": "启动关闭运动循环。",
      "detail": null,
      "type": "loop"
    },
    {
      "id": "N26",
      "title": "关闭运动初始化",
      "summary": "启用电机供电并为关闭准备速度模式。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N27",
      "title": "关闭目标与速度计算",
      "summary": "计算关闭目标（0）和带偏置的速度。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N28",
      "title": "关闭速度计算与指令",
      "summary": "计算并发送关闭速度指令给电机。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N29",
      "title": "关闭停止条件检查",
      "summary": "检查是否已关闭、未达到目标、堵转或中断。",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N30",
      "title": "关闭停止动作",
      "summary": "处理关闭完成或中断；收紧配合或切换到打开。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N31",
      "title": "关闭过程中的开启中断",
      "summary": "若在关闭途中收到新的开启命令，切换到开启动作。",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N32",
      "title": "切换到开启动作",
      "summary": "在中断后开始开启运动。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N33",
      "title": "关闭后电源关闭与睡眠准备",
      "summary": "关闭外围设备，重置偏航角，并保存雷达阈值。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N35",
      "title": "空闲超时管理",
      "summary": "在空闲期后在进入睡眠或自动关闭之间进行决策。",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N36",
      "title": "进入低功耗睡眠",
      "summary": "将 IMU、蓝牙和雷达置于睡眠；按配置进行电源关闭。",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N37",
      "title": "从睡眠中唤醒",
      "summary": "在活动时唤醒并恢复正常操作。",
      "detail": null,
      "type": "edge"
    },
    {
      "id": "N38",
      "title": "结束",
      "summary": "本图的可选终止点。",
      "detail": null,
      "type": "end"
    }
  ],
  "edges": [
    {
      "source": "N1",
      "target": "N2",
      "label": null
    },
    {
      "source": "N2",
      "target": "N3",
      "label": null
    },
    {
      "source": "N3",
      "target": "N4",
      "label": null
    },
    {
      "source": "N4",
      "target": "N8",
      "label": "标定已存在 = 真"
    },
    {
      "source": "N4",
      "target": "N6",
      "label": "标定不存在 = 假"
    },
    {
      "source": "N6",
      "target": "N7",
      "label": null
    },
    {
      "source": "N7",
      "target": "N8",
      "label": null
    },
    {
      "source": "N8",
      "target": "N9",
      "label": null
    },
    {
      "source": "N9",
      "target": "N10",
      "label": null
    },
    {
      "source": "N10",
      "target": "N11",
      "label": null
    },
    {
      "source": "N11",
      "target": "N12",
      "label": null
    },
    {
      "source": "N12",
      "target": "N13",
      "label": null
    },
    {
      "source": "N13",
      "target": "N14",
      "label": null
    },
    {
      "source": "N14",
      "target": "N15",
      "label": "AA00 激活"
    },
    {
      "source": "N14",
      "target": "N16",
      "label": "AA00 未激活"
    },
    {
      "source": "N15",
      "target": "N8",
      "label": null
    },
    {
      "source": "N16",
      "target": "N17",
      "label": null
    },
    {
      "source": "N17",
      "target": "N18",
      "label": null
    },
    {
      "source": "N18",
      "target": "N19",
      "label": null
    },
    {
      "source": "N19",
      "target": "N20",
      "label": null
    },
    {
      "source": "N20",
      "target": "N21",
      "label": null
    },
    {
      "source": "N21",
      "target": "N22",
      "label": null
    },
    {
      "source": "N22",
      "target": "N23",
      "label": "停止"
    },
    {
      "source": "N22",
      "target": "N21",
      "label": "继续"
    },
    {
      "source": "N23",
      "target": "N24",
      "label": null
    },
    {
      "source": "N24",
      "target": "N25",
      "label": null
    },
    {
      "source": "N25",
      "target": "N26",
      "label": null
    },
    {
      "source": "N26",
      "target": "N27",
      "label": null
    },
    {
      "source": "N27",
      "target": "N28",
      "label": null
    },
    {
      "source": "N28",
      "target": "N29",
      "label": null
    },
    {
      "source": "N29",
      "target": "N30",
      "label": null
    },
    {
      "source": "N30",
      "target": "N31",
      "label": null
    },
    {
      "source": "N31",
      "target": "N32",
      "label": "因开启而中断"
    },
    {
      "source": "N31",
      "target": "N33",
      "label": "无中断"
    },
    {
      "source": "N32",
      "target": "N17",
      "label": "切换到开启动作"
    },
    {
      "source": "N33",
      "target": "N8",
      "label": null
    },
    {
      "source": "N8",
      "target": "N35",
      "label": "空闲超时"
    },
    {
      "source": "N35",
      "target": "N36",
      "label": "睡眠"
    },
    {
      "source": "N36",
      "target": "N9",
      "label": "活动唤醒"
    },
    {
      "source": "N36",
      "target": "N37",
      "label": "唤醒事件"
    },
    {
      "source": "N37",
      "target": "N8",
      "label": "恢复"
    },
    {
      "source": "N18",
      "target": "N23",
      "label": "初始化后继续开启"
    }
  ]
}