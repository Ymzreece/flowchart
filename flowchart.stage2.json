{
  "language": "text",
  "metadata": {
    "title": "Door Control Firmware - Flash_Task State Machine Flow",
    "summary": "Structured flow reflecting the Flash_Task loop, menus, states, and background activities including config, do-not-disturb, calibration, and delete flows.",
    "language": "text"
  },
  "functions": [
    {
      "name": "Door Control Firmware - Flash_Task State Machine Flow",
      "nodes": [
        {
          "id": "start",
          "kind": "start",
          "label": "Firmware boot and initial entry into the Flash_Task loop",
          "summary": "Firmware boot and initial entry into the Flash_Task loop",
          "metadata": {
            "title": "System Start",
            "detail": null,
            "type": "start"
          }
        },
        {
          "id": "main_dispatch",
          "kind": "statement",
          "label": "Continually checks system_state and delegates to menus or services",
          "summary": "Continually checks system_state and delegates to menus or services",
          "metadata": {
            "title": "Flash_Task Main Dispatcher",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "system_idle",
          "kind": "loop",
          "label": "Idle state: wait for input, then possibly enter low-power mode",
          "summary": "Idle state: wait for input, then possibly enter low-power mode",
          "metadata": {
            "title": "SYSTEM_IDLE",
            "detail": "After ~2 seconds of inactivity, initiate low-power power-down sequence (BT disconnects, display off, NMOS gating, etc.)",
            "type": "loop"
          }
        },
        {
          "id": "top_menu",
          "kind": "statement",
          "label": "Icon choices: Config, Else Mode, Back; supports navigation and long-press actions",
          "summary": "Icon choices: Config, Else Mode, Back; supports navigation and long-press actions",
          "metadata": {
            "title": "Top-level Icon Menu (menu1)",
            "detail": "Short presses rotate selection; long-press on key3 enters Do Not Disturb; long-press on key2 enters Door Calibration",
            "type": "process"
          }
        },
        {
          "id": "top_menu_nav_loop",
          "kind": "loop",
          "label": "Handles Key1/Key3 navigation; updates selected icon; wraps around",
          "summary": "Handles Key1/Key3 navigation; updates selected icon; wraps around",
          "metadata": {
            "title": "Top Menu Navigation Loop",
            "detail": null,
            "type": "loop"
          }
        },
        {
          "id": "menu_config",
          "kind": "statement",
          "label": "Launch Radar Config flow and user config editing",
          "summary": "Launch Radar Config flow and user config editing",
          "metadata": {
            "title": "Handle Config Menu (menu1 -> 1)",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "menu_else_mode",
          "kind": "statement",
          "label": "Do Not Disturb, Door Calibration (hidden), Back",
          "summary": "Do Not Disturb, Door Calibration (hidden), Back",
          "metadata": {
            "title": "Handle Else Mode Menu (menu1 -> 2)",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "do_not_disturb",
          "kind": "loop",
          "label": "Suppress outputs; exit on key press; optionally silent; PIC/Motion triggers display if not silent",
          "summary": "Suppress outputs; exit on key press; optionally silent; PIC/Motion triggers display if not silent",
          "metadata": {
            "title": "Do Not Disturb State",
            "detail": "Sends AA0055 each loop; if LoRa flag set, send AARF55; PIR triggers display when not silent",
            "type": "loop"
          }
        },
        {
          "id": "door_calibration_flow",
          "kind": "statement",
          "label": "Notify Bluetooth, prompt user, wait for key, run calibration progress, then return",
          "summary": "Notify Bluetooth, prompt user, wait for key, run calibration progress, then return",
          "metadata": {
            "title": "Hidden Door Calibration Flow",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "delete_menu",
          "kind": "statement",
          "label": "Options to Reset All or Reset Single (not fully implemented)",
          "summary": "Options to Reset All or Reset Single (not fully implemented)",
          "metadata": {
            "title": "Reset/Delete Menu",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "delete_all_flow",
          "kind": "statement",
          "label": "Progress bar; clear all users; determine success/fail",
          "summary": "Progress bar; clear all users; determine success/fail",
          "metadata": {
            "title": "Reset All Flow",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "face_op_progress",
          "kind": "statement",
          "label": "Face enrollment/verification/delete progress states",
          "summary": "Face enrollment/verification/delete progress states",
          "metadata": {
            "title": "Face Operation Progress",
            "detail": "Includes FACE_VERIFYING, FACE_ENROLL_SUCCESS/FAIL, FACE_DELETE_SUCCESS/FAIL",
            "type": "process"
          }
        },
        {
          "id": "face_verify_in_progress",
          "kind": "statement",
          "label": "Face verification in progress",
          "summary": "Face verification in progress",
          "metadata": {
            "title": "FACE_VERIFYING",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "face_verify_success",
          "kind": "statement",
          "label": "Face verification succeeded",
          "summary": "Face verification succeeded",
          "metadata": {
            "title": "FACE_VERIFY_SUCCESS",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "face_verify_fail",
          "kind": "statement",
          "label": "Face verification failed",
          "summary": "Face verification failed",
          "metadata": {
            "title": "FACE_VERIFY_FAIL",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "face_enroll_success",
          "kind": "statement",
          "label": "Face enroll completed",
          "summary": "Face enroll completed",
          "metadata": {
            "title": "FACE_ENROLL_SUCCESS",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "face_enroll_fail",
          "kind": "statement",
          "label": "Face enroll failed",
          "summary": "Face enroll failed",
          "metadata": {
            "title": "FACE_ENROLL_FAIL",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "face_delete_in_progress",
          "kind": "statement",
          "label": "Deleting face data in progress",
          "summary": "Deleting face data in progress",
          "metadata": {
            "title": "FACE_DELETE_IN_PROGRESS",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "face_delete_success",
          "kind": "statement",
          "label": "All face data deleted successfully",
          "summary": "All face data deleted successfully",
          "metadata": {
            "title": "FACE_DELETE_SUCCESS",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "face_delete_fail",
          "kind": "statement",
          "label": "Face delete operation failed",
          "summary": "Face delete operation failed",
          "metadata": {
            "title": "FACE_DELETE_FAIL",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "config_menu",
          "kind": "statement",
          "label": "Radar Config \u2192 user config \u2192 angle/speed editing",
          "summary": "Radar Config \u2192 user config \u2192 angle/speed editing",
          "metadata": {
            "title": "Configuration Workflow (config menu)",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "config_radar_anim",
          "kind": "statement",
          "label": "Slide-in animation during config",
          "summary": "Slide-in animation during config",
          "metadata": {
            "title": "Radar Config Animation",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "config_user_load",
          "kind": "statement",
          "label": "Attempt to load from flash; fall back to defaults",
          "summary": "Attempt to load from flash; fall back to defaults",
          "metadata": {
            "title": "Load or Defaults for User Config",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "config_angle_speed_screen",
          "kind": "statement",
          "label": "5 options: Angle, Speed, Auto Close, Save, Exit",
          "summary": "5 options: Angle, Speed, Auto Close, Save, Exit",
          "metadata": {
            "title": "Angle/Speed/Auto Close Screen",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "config_saving_progress",
          "kind": "loop",
          "label": "Progress bar ~2 seconds while erasing/writing flash and CRC",
          "summary": "Progress bar ~2 seconds while erasing/writing flash and CRC",
          "metadata": {
            "title": "Saving config...",
            "detail": null,
            "type": "loop"
          }
        },
        {
          "id": "config_flash_write",
          "kind": "statement",
          "label": "Erase necessary pages; write 8-byte aligned; CRC",
          "summary": "Erase necessary pages; write 8-byte aligned; CRC",
          "metadata": {
            "title": "Flash Write for User Config",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "config_crc_verify",
          "kind": "statement",
          "label": "Reload and verify CRC after write",
          "summary": "Reload and verify CRC after write",
          "metadata": {
            "title": "CRC Verification",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "config_back_to_menu",
          "kind": "statement",
          "label": "After configuration, return to top-level menu",
          "summary": "After configuration, return to top-level menu",
          "metadata": {
            "title": "Return to Top Menu",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "lora_rx_handling",
          "kind": "statement",
          "label": "Respond to packets with AARI55 / AARF55 as appropriate",
          "summary": "Respond to packets with AARI55 / AARF55 as appropriate",
          "metadata": {
            "title": "LoRa RX Handling",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "battery_update_loop",
          "kind": "loop",
          "label": "Periodically refresh battery status and UI",
          "summary": "Periodically refresh battery status and UI",
          "metadata": {
            "title": "Battery Update Background",
            "detail": null,
            "type": "loop"
          }
        },
        {
          "id": "pir_check",
          "kind": "statement",
          "label": "Poll PIR and trigger Do Not Disturb messages if active",
          "summary": "Poll PIR and trigger Do Not Disturb messages if active",
          "metadata": {
            "title": "PIR Motion Check",
            "detail": null,
            "type": "process"
          }
        },
        {
          "id": "end",
          "kind": "end",
          "label": "Flow termination point (not typically reached in normal operation)",
          "summary": "Flow termination point (not typically reached in normal operation)",
          "metadata": {
            "title": "End",
            "detail": null,
            "type": "end"
          }
        }
      ],
      "edges": [
        {
          "source": "start",
          "target": "system_idle",
          "label": "boot / power-on"
        },
        {
          "source": "system_idle",
          "target": "top_menu",
          "label": "Key press to wake / user activity"
        },
        {
          "source": "top_menu",
          "target": "top_menu_nav_loop",
          "label": "Key1 short press (navigate left)"
        },
        {
          "source": "top_menu",
          "target": "top_menu_nav_loop",
          "label": "Key3 short press (navigate right)"
        },
        {
          "source": "top_menu_nav_loop",
          "target": "top_menu",
          "label": "Navigation updated (loop)"
        },
        {
          "source": "top_menu",
          "target": "menu_config",
          "label": "Key2 pressed with selection = Config"
        },
        {
          "source": "top_menu",
          "target": "menu_else_mode",
          "label": "Key2 pressed with selection = Else Mode"
        },
        {
          "source": "top_menu",
          "target": "system_idle",
          "label": "Key2 pressed with selection = Back"
        },
        {
          "source": "top_menu",
          "target": "do_not_disturb",
          "label": "Long press on Key3 -> Do Not Disturb"
        },
        {
          "source": "top_menu",
          "target": "door_calibration_flow",
          "label": "Long press on Key2 -> Door Calibration"
        },
        {
          "source": "menu_config",
          "target": "config_menu",
          "label": "Enter Radar Config / Config flow"
        },
        {
          "source": "config_menu",
          "target": "config_radar_anim",
          "label": "Start Radar Config animation"
        },
        {
          "source": "config_radar_anim",
          "target": "config_user_load",
          "label": "Select user_id=1 and load config"
        },
        {
          "source": "config_user_load",
          "target": "config_angle_speed_screen",
          "label": "Load existing or defaults -> go to Angle/Speed screen"
        },
        {
          "source": "config_angle_speed_screen",
          "target": "config_saving_progress",
          "label": "Choose Save"
        },
        {
          "source": "config_angle_speed_screen",
          "target": "config_back_to_menu",
          "label": "Choose Exit without saving"
        },
        {
          "source": "config_saving_progress",
          "target": "face_enroll_success",
          "label": "Save success (CRC ok)"
        },
        {
          "source": "config_saving_progress",
          "target": "face_enroll_fail",
          "label": "Save failure (CRC error)"
        },
        {
          "source": "face_enroll_success",
          "target": "top_menu",
          "label": "Return to Top Menu"
        },
        {
          "source": "face_enroll_fail",
          "target": "top_menu",
          "label": "Return to Top Menu"
        },
        {
          "source": "menu_else_mode",
          "target": "do_not_disturb",
          "label": "Select Do Not Disturb"
        },
        {
          "source": "menu_else_mode",
          "target": "door_calibration_flow",
          "label": "Select Door Reset (Calibration)"
        },
        {
          "source": "menu_else_mode",
          "target": "top_menu",
          "label": "Select Back"
        },
        {
          "source": "door_calibration_flow",
          "target": "door_calibration_flow",
          "label": "Start calibration"
        },
        {
          "source": "door_calibration_flow",
          "target": "door_calibration_flow",
          "label": "Open door to max angle and press key (step)"
        },
        {
          "source": "door_calibration_flow",
          "target": "door_calibration_flow",
          "label": "Bluetooth notify AARE55 / AA0055 sequence"
        },
        {
          "source": "door_calibration_flow",
          "target": "top_menu",
          "label": "Calibration Complete -> Return to Top Menu"
        },
        {
          "source": "delete_menu",
          "target": "delete_all_flow",
          "label": "Reset All selected"
        },
        {
          "source": "delete_menu",
          "target": "delete_all_flow",
          "label": "Reset All selected (alternate path)"
        },
        {
          "source": "delete_menu",
          "target": "top_menu",
          "label": "Back selected"
        },
        {
          "source": "delete_all_flow",
          "target": "face_delete_success",
          "label": "Delete success"
        },
        {
          "source": "delete_all_flow",
          "target": "face_delete_fail",
          "label": "Delete fail"
        },
        {
          "source": "face_delete_success",
          "target": "top_menu",
          "label": "Return to Top Menu"
        },
        {
          "source": "face_delete_fail",
          "target": "top_menu",
          "label": "Return to Top Menu"
        },
        {
          "source": "face_op_progress",
          "target": "face_verify_success",
          "label": "Verification success"
        },
        {
          "source": "face_verify_in_progress",
          "target": "face_verify_success",
          "label": "Success"
        },
        {
          "source": "face_verify_in_progress",
          "target": "face_verify_fail",
          "label": "Fail"
        },
        {
          "source": "face_verify_success",
          "target": "top_menu",
          "label": "Return to Top Menu"
        },
        {
          "source": "face_verify_fail",
          "target": "top_menu",
          "label": "Return to Top Menu"
        },
        {
          "source": "lora_rx_handling",
          "target": "face_verify_success",
          "label": "AARI55 (verify) received"
        },
        {
          "source": "lora_rx_handling",
          "target": "face_enroll_success",
          "label": "AARF55 (hard/Do Not Disturb context) received"
        },
        {
          "source": "battery_update_loop",
          "target": "top_menu",
          "label": "Battery status updated"
        },
        {
          "source": "pir_check",
          "target": "do_not_disturb",
          "label": "PIR detected (not silent)"
        },
        {
          "source": "do_not_disturb",
          "target": "top_menu",
          "label": "Any short press exits Do Not Disturb"
        },
        {
          "source": "do_not_disturb",
          "target": "do_not_disturb",
          "label": "PIR motion during silent keeps display blank"
        },
        {
          "source": "top_menu",
          "target": "end",
          "label": "End of flow (idle termination not typical)"
        }
      ],
      "parameters": [],
      "metadata": {
        "entry_node": "start"
      },
      "docstring": "Structured flow reflecting the Flash_Task loop, menus, states, and background activities including config, do-not-disturb, calibration, and delete flows."
    }
  ]
}