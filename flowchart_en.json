{
  "metadata": {
    "title": "Control loop graph for motorized mechanism (embedded system)",
    "summary": "Structured flowchart of the main control loop: initialization, calibration handling, inputs (LoRa, Bluetooth, IMU, GPIO), motion control (open/close), stall safety, power management, and persistence.",
    "language": "en"
  },
  "entry_node": "N1",
  "nodes": [
    {
      "id": "N1",
      "title": "Power-Up and Resume",
      "summary": "System starts, initializes hardware, and resumes a known state.",
      "detail": null,
      "type": "start"
    },
    {
      "id": "N2",
      "title": "Initialize peripherals and stop motor",
      "summary": "Set up sensors/IO, ensure motor is idle, and prepare for operation.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N3",
      "title": "Read calibration data from flash",
      "summary": "Load diff_sumup and check_flag from flash storage.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N4",
      "title": "Calibration presence check",
      "summary": "Is the system already calibrated (check_flag true)?",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N6",
      "title": "Await LoRa frame for Auto_Check",
      "summary": "If not calibrated, wait for a LoRa frame to trigger Auto_Check.",
      "detail": null,
      "type": "loop"
    },
    {
      "id": "N7",
      "title": "Auto_Check calibration",
      "summary": "Run Auto_Check to determine limits and maximum yaw (diff_sumup).",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N8",
      "title": "Enter normal operation loop",
      "summary": "Main 10 ms control loop for normal operation.",
      "detail": null,
      "type": "loop"
    },
    {
      "id": "N9",
      "title": "Bluetooth command parsing",
      "summary": "Parse commands from XY_MB06BA device.",
      "detail": null,
      "type": "call"
    },
    {
      "id": "N10",
      "title": "LoRa frame parsing",
      "summary": "Process inbound LoRa frames and update lora_rx_buf.",
      "detail": null,
      "type": "call"
    },
    {
      "id": "N11",
      "title": "LoRa/command handling",
      "summary": "Handle AA00, AAxy, AAOF and AARE command types.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N12",
      "title": "IMU/Yaw update",
      "summary": "Update yaw and motion feedback from IMU sensors.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N13",
      "title": "Bus current read",
      "summary": "Read motor bus current for safety/diagnostics.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N14",
      "title": "External flags and manual input check",
      "summary": "Read ahead_flag, back_flag and PB6 edge signals.",
      "detail": null,
      "type": "io"
    },
    {
      "id": "N15",
      "title": "AA00 power-hold active?",
      "summary": "Decision: is the AA00 power-hold state currently active?",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N16",
      "title": "Maintain motor power while AA00 is active",
      "summary": "Keep motor power on while AA00 is enabling motion or holding power.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N17",
      "title": "Open motion decision",
      "summary": "Should the system start opening now based on commands/flags?",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N18",
      "title": "Open motion loop",
      "summary": "Open motion loop that drives opening until a stop condition is met.",
      "detail": null,
      "type": "loop"
    },
    {
      "id": "N19",
      "title": "Open motion initialization",
      "summary": "Enable motor power, reset timers, and switch to speed mode for opening.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N20",
      "title": "Open target threshold calculation",
      "summary": "Compute target yaw threshold from diff_sumup and angle level.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N21",
      "title": "Open speed command calculation",
      "summary": "speed = Motor_P * (threshold - yaw), clamped to safety limits.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N22",
      "title": "Open stop condition check",
      "summary": "Evaluate if the opening should stop due to target, overshoot, or stall.",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N23",
      "title": "Open stop actions",
      "summary": "Stop motor, clear flags; possibly queue close if AAOF was set.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N24",
      "title": "AAOF triggers close",
      "summary": "If AAOF was requested, prepare to close after finishing the open.",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N25",
      "title": "Start close motion",
      "summary": "Initiate the closing motion loop.",
      "detail": null,
      "type": "loop"
    },
    {
      "id": "N26",
      "title": "Close motion initialization",
      "summary": "Enable motor power and prepare speed mode for closing.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N27",
      "title": "Close target and speed calculation",
      "summary": "Compute target (0) and speed for closing with bias.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N28",
      "title": "Close speed calculation and command",
      "summary": "Compute and send closing speed command to motor.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N29",
      "title": "Close stop condition check",
      "summary": "Check if closed, undershot, stall, or interrupted.",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N30",
      "title": "Close stop action",
      "summary": "Handle close completion or interruption; snug the fit or switch to open.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N31",
      "title": "Open interruption during close",
      "summary": "If a new open command arrives mid-close, switch to open motion.",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N32",
      "title": "Switch to open motion",
      "summary": "Begin opening after interruption during closing.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N33",
      "title": "Post-close power-down and sleep prep",
      "summary": "Power down peripherals, reset yaw, and save radar threshold.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N35",
      "title": "Idle timeout management",
      "summary": "Decide between entering sleep or auto-close after idle period.",
      "detail": null,
      "type": "decision"
    },
    {
      "id": "N36",
      "title": "Enter low-power sleep",
      "summary": "Sleep IMU, Bluetooth, and radar; power down as configured.",
      "detail": null,
      "type": "process"
    },
    {
      "id": "N37",
      "title": "Wake from sleep",
      "summary": "Wake up on activity and resume normal operation.",
      "detail": null,
      "type": "edge"
    },
    {
      "id": "N38",
      "title": "End",
      "summary": "Optional termination point for the diagram.",
      "detail": null,
      "type": "end"
    }
  ],
  "edges": [
    {
      "source": "N1",
      "target": "N2",
      "label": null
    },
    {
      "source": "N2",
      "target": "N3",
      "label": null
    },
    {
      "source": "N3",
      "target": "N4",
      "label": null
    },
    {
      "source": "N4",
      "target": "N8",
      "label": "calibration_present = true"
    },
    {
      "source": "N4",
      "target": "N6",
      "label": "calibration_present = false"
    },
    {
      "source": "N6",
      "target": "N7",
      "label": null
    },
    {
      "source": "N7",
      "target": "N8",
      "label": null
    },
    {
      "source": "N8",
      "target": "N9",
      "label": null
    },
    {
      "source": "N9",
      "target": "N10",
      "label": null
    },
    {
      "source": "N10",
      "target": "N11",
      "label": null
    },
    {
      "source": "N11",
      "target": "N12",
      "label": null
    },
    {
      "source": "N12",
      "target": "N13",
      "label": null
    },
    {
      "source": "N13",
      "target": "N14",
      "label": null
    },
    {
      "source": "N14",
      "target": "N15",
      "label": "AA00 active"
    },
    {
      "source": "N14",
      "target": "N16",
      "label": "AA00 inactive"
    },
    {
      "source": "N15",
      "target": "N8",
      "label": null
    },
    {
      "source": "N16",
      "target": "N17",
      "label": null
    },
    {
      "source": "N17",
      "target": "N18",
      "label": null
    },
    {
      "source": "N18",
      "target": "N19",
      "label": null
    },
    {
      "source": "N19",
      "target": "N20",
      "label": null
    },
    {
      "source": "N20",
      "target": "N21",
      "label": null
    },
    {
      "source": "N21",
      "target": "N22",
      "label": null
    },
    {
      "source": "N22",
      "target": "N23",
      "label": "stop"
    },
    {
      "source": "N22",
      "target": "N21",
      "label": "continue"
    },
    {
      "source": "N23",
      "target": "N24",
      "label": null
    },
    {
      "source": "N24",
      "target": "N25",
      "label": null
    },
    {
      "source": "N25",
      "target": "N26",
      "label": null
    },
    {
      "source": "N26",
      "target": "N27",
      "label": null
    },
    {
      "source": "N27",
      "target": "N28",
      "label": null
    },
    {
      "source": "N28",
      "target": "N29",
      "label": null
    },
    {
      "source": "N29",
      "target": "N30",
      "label": null
    },
    {
      "source": "N30",
      "target": "N31",
      "label": null
    },
    {
      "source": "N31",
      "target": "N32",
      "label": "interrupted_by_open"
    },
    {
      "source": "N31",
      "target": "N33",
      "label": "no_interrupt"
    },
    {
      "source": "N32",
      "target": "N17",
      "label": "switch_to_open_motion"
    },
    {
      "source": "N33",
      "target": "N8",
      "label": null
    },
    {
      "source": "N8",
      "target": "N35",
      "label": "idle_timeout"
    },
    {
      "source": "N35",
      "target": "N36",
      "label": "sleep"
    },
    {
      "source": "N36",
      "target": "N9",
      "label": "wake_on_activity"
    },
    {
      "source": "N36",
      "target": "N37",
      "label": "wake_event"
    },
    {
      "source": "N37",
      "target": "N8",
      "label": "resume"
    },
    {
      "source": "N18",
      "target": "N23",
      "label": "continue_open_after_init"
    }
  ]
}