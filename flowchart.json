{
  "metadata": {
    "title": "Door Control Firmware - Flash_Task State Machine Flow",
    "summary": "Structured flow reflecting the Flash_Task loop, menus, states, and background activities including config, do-not-disturb, calibration, and delete flows.",
    "language": "text"
  },
  "entry_node": "start",
  "nodes": [
    {
      "id": "start",
      "title": "System Start",
      "summary": "Firmware boot and initial entry into the Flash_Task loop",
      "detail": null,
      "type": "start"
    },
    {
      "id": "main_dispatch",
      "title": "Flash_Task Main Dispatcher",
      "summary": "Continually checks system_state and delegates to menus or services",
      "detail": null,
      "type": "process"
    },
    {
      "id": "system_idle",
      "title": "SYSTEM_IDLE",
      "summary": "Idle state: wait for input, then possibly enter low-power mode",
      "detail": "After ~2 seconds of inactivity, initiate low-power power-down sequence (BT disconnects, display off, NMOS gating, etc.)",
      "type": "loop"
    },
    {
      "id": "top_menu",
      "title": "Top-level Icon Menu (menu1)",
      "summary": "Icon choices: Config, Else Mode, Back; supports navigation and long-press actions",
      "detail": "Short presses rotate selection; long-press on key3 enters Do Not Disturb; long-press on key2 enters Door Calibration",
      "type": "process"
    },
    {
      "id": "top_menu_nav_loop",
      "title": "Top Menu Navigation Loop",
      "summary": "Handles Key1/Key3 navigation; updates selected icon; wraps around",
      "detail": null,
      "type": "loop"
    },
    {
      "id": "menu_config",
      "title": "Handle Config Menu (menu1 -> 1)",
      "summary": "Launch Radar Config flow and user config editing",
      "detail": null,
      "type": "process"
    },
    {
      "id": "menu_else_mode",
      "title": "Handle Else Mode Menu (menu1 -> 2)",
      "summary": "Do Not Disturb, Door Calibration (hidden), Back",
      "detail": null,
      "type": "process"
    },
    {
      "id": "do_not_disturb",
      "title": "Do Not Disturb State",
      "summary": "Suppress outputs; exit on key press; optionally silent; PIC/Motion triggers display if not silent",
      "detail": "Sends AA0055 each loop; if LoRa flag set, send AARF55; PIR triggers display when not silent",
      "type": "loop"
    },
    {
      "id": "door_calibration_flow",
      "title": "Hidden Door Calibration Flow",
      "summary": "Notify Bluetooth, prompt user, wait for key, run calibration progress, then return",
      "detail": null,
      "type": "process"
    },
    {
      "id": "delete_menu",
      "title": "Reset/Delete Menu",
      "summary": "Options to Reset All or Reset Single (not fully implemented)",
      "detail": null,
      "type": "process"
    },
    {
      "id": "delete_all_flow",
      "title": "Reset All Flow",
      "summary": "Progress bar; clear all users; determine success/fail",
      "detail": null,
      "type": "process"
    },
    {
      "id": "face_op_progress",
      "title": "Face Operation Progress",
      "summary": "Face enrollment/verification/delete progress states",
      "detail": "Includes FACE_VERIFYING, FACE_ENROLL_SUCCESS/FAIL, FACE_DELETE_SUCCESS/FAIL",
      "type": "process"
    },
    {
      "id": "face_verify_in_progress",
      "title": "FACE_VERIFYING",
      "summary": "Face verification in progress",
      "detail": null,
      "type": "process"
    },
    {
      "id": "face_verify_success",
      "title": "FACE_VERIFY_SUCCESS",
      "summary": "Face verification succeeded",
      "detail": null,
      "type": "process"
    },
    {
      "id": "face_verify_fail",
      "title": "FACE_VERIFY_FAIL",
      "summary": "Face verification failed",
      "detail": null,
      "type": "process"
    },
    {
      "id": "face_enroll_success",
      "title": "FACE_ENROLL_SUCCESS",
      "summary": "Face enroll completed",
      "detail": null,
      "type": "process"
    },
    {
      "id": "face_enroll_fail",
      "title": "FACE_ENROLL_FAIL",
      "summary": "Face enroll failed",
      "detail": null,
      "type": "process"
    },
    {
      "id": "face_delete_in_progress",
      "title": "FACE_DELETE_IN_PROGRESS",
      "summary": "Deleting face data in progress",
      "detail": null,
      "type": "process"
    },
    {
      "id": "face_delete_success",
      "title": "FACE_DELETE_SUCCESS",
      "summary": "All face data deleted successfully",
      "detail": null,
      "type": "process"
    },
    {
      "id": "face_delete_fail",
      "title": "FACE_DELETE_FAIL",
      "summary": "Face delete operation failed",
      "detail": null,
      "type": "process"
    },
    {
      "id": "config_menu",
      "title": "Configuration Workflow (config menu)",
      "summary": "Radar Config \u2192 user config \u2192 angle/speed editing",
      "detail": null,
      "type": "process"
    },
    {
      "id": "config_radar_anim",
      "title": "Radar Config Animation",
      "summary": "Slide-in animation during config",
      "detail": null,
      "type": "process"
    },
    {
      "id": "config_user_load",
      "title": "Load or Defaults for User Config",
      "summary": "Attempt to load from flash; fall back to defaults",
      "detail": null,
      "type": "process"
    },
    {
      "id": "config_angle_speed_screen",
      "title": "Angle/Speed/Auto Close Screen",
      "summary": "5 options: Angle, Speed, Auto Close, Save, Exit",
      "detail": null,
      "type": "process"
    },
    {
      "id": "config_saving_progress",
      "title": "Saving config...",
      "summary": "Progress bar ~2 seconds while erasing/writing flash and CRC",
      "detail": null,
      "type": "loop"
    },
    {
      "id": "config_flash_write",
      "title": "Flash Write for User Config",
      "summary": "Erase necessary pages; write 8-byte aligned; CRC",
      "detail": null,
      "type": "process"
    },
    {
      "id": "config_crc_verify",
      "title": "CRC Verification",
      "summary": "Reload and verify CRC after write",
      "detail": null,
      "type": "process"
    },
    {
      "id": "config_back_to_menu",
      "title": "Return to Top Menu",
      "summary": "After configuration, return to top-level menu",
      "detail": null,
      "type": "process"
    },
    {
      "id": "lora_rx_handling",
      "title": "LoRa RX Handling",
      "summary": "Respond to packets with AARI55 / AARF55 as appropriate",
      "detail": null,
      "type": "process"
    },
    {
      "id": "battery_update_loop",
      "title": "Battery Update Background",
      "summary": "Periodically refresh battery status and UI",
      "detail": null,
      "type": "loop"
    },
    {
      "id": "pir_check",
      "title": "PIR Motion Check",
      "summary": "Poll PIR and trigger Do Not Disturb messages if active",
      "detail": null,
      "type": "process"
    },
    {
      "id": "end",
      "title": "End",
      "summary": "Flow termination point (not typically reached in normal operation)",
      "detail": null,
      "type": "end"
    }
  ],
  "edges": [
    {
      "source": "start",
      "target": "system_idle",
      "label": "boot / power-on"
    },
    {
      "source": "system_idle",
      "target": "top_menu",
      "label": "Key press to wake / user activity"
    },
    {
      "source": "top_menu",
      "target": "top_menu_nav_loop",
      "label": "Key1 short press (navigate left)"
    },
    {
      "source": "top_menu",
      "target": "top_menu_nav_loop",
      "label": "Key3 short press (navigate right)"
    },
    {
      "source": "top_menu_nav_loop",
      "target": "top_menu",
      "label": "Navigation updated (loop)"
    },
    {
      "source": "top_menu",
      "target": "menu_config",
      "label": "Key2 pressed with selection = Config"
    },
    {
      "source": "top_menu",
      "target": "menu_else_mode",
      "label": "Key2 pressed with selection = Else Mode"
    },
    {
      "source": "top_menu",
      "target": "system_idle",
      "label": "Key2 pressed with selection = Back"
    },
    {
      "source": "top_menu",
      "target": "do_not_disturb",
      "label": "Long press on Key3 -> Do Not Disturb"
    },
    {
      "source": "top_menu",
      "target": "door_calibration_flow",
      "label": "Long press on Key2 -> Door Calibration"
    },
    {
      "source": "menu_config",
      "target": "config_menu",
      "label": "Enter Radar Config / Config flow"
    },
    {
      "source": "config_menu",
      "target": "config_radar_anim",
      "label": "Start Radar Config animation"
    },
    {
      "source": "config_radar_anim",
      "target": "config_user_load",
      "label": "Select user_id=1 and load config"
    },
    {
      "source": "config_user_load",
      "target": "config_angle_speed_screen",
      "label": "Load existing or defaults -> go to Angle/Speed screen"
    },
    {
      "source": "config_angle_speed_screen",
      "target": "config_saving_progress",
      "label": "Choose Save"
    },
    {
      "source": "config_angle_speed_screen",
      "target": "config_back_to_menu",
      "label": "Choose Exit without saving"
    },
    {
      "source": "config_saving_progress",
      "target": "face_enroll_success",
      "label": "Save success (CRC ok)"
    },
    {
      "source": "config_saving_progress",
      "target": "face_enroll_fail",
      "label": "Save failure (CRC error)"
    },
    {
      "source": "face_enroll_success",
      "target": "top_menu",
      "label": "Return to Top Menu"
    },
    {
      "source": "face_enroll_fail",
      "target": "top_menu",
      "label": "Return to Top Menu"
    },
    {
      "source": "menu_else_mode",
      "target": "do_not_disturb",
      "label": "Select Do Not Disturb"
    },
    {
      "source": "menu_else_mode",
      "target": "door_calibration_flow",
      "label": "Select Door Reset (Calibration)"
    },
    {
      "source": "menu_else_mode",
      "target": "top_menu",
      "label": "Select Back"
    },
    {
      "source": "door_calibration_flow",
      "target": "door_calibration_flow",
      "label": "Start calibration",
      "forwards": true
    },
    {
      "source": "door_calibration_flow",
      "target": "door_calibration_flow",
      "label": "Open door to max angle and press key (step)"
    },
    {
      "source": "door_calibration_flow",
      "target": "door_calibration_flow",
      "label": "Bluetooth notify AARE55 / AA0055 sequence"
    },
    {
      "source": "door_calibration_flow",
      "target": "top_menu",
      "label": "Calibration Complete -> Return to Top Menu"
    },
    {
      "source": "delete_menu",
      "target": "delete_all_flow",
      "label": "Reset All selected"
    },
    {
      "source": "delete_menu",
      "target": "delete_all_flow",
      "label": "Reset All selected (alternate path)"
    },
    {
      "source": "delete_menu",
      "target": "top_menu",
      "label": "Back selected"
    },
    {
      "source": "delete_all_flow",
      "target": "face_delete_success",
      "label": "Delete success"
    },
    {
      "source": "delete_all_flow",
      "target": "face_delete_fail",
      "label": "Delete fail"
    },
    {
      "source": "face_delete_success",
      "target": "top_menu",
      "label": "Return to Top Menu"
    },
    {
      "source": "face_delete_fail",
      "target": "top_menu",
      "label": "Return to Top Menu"
    },
    {
      "source": "face_op_progress",
      "target": "face_verify_success",
      "label": "Verification success"
    },
    {
      "source": "face_verify_in_progress",
      "target": "face_verify_success",
      "label": "Success"
    },
    {
      "source": "face_verify_in_progress",
      "target": "face_verify_fail",
      "label": "Fail"
    },
    {
      "source": "face_verify_success",
      "target": "top_menu",
      "label": "Return to Top Menu"
    },
    {
      "source": "face_verify_fail",
      "target": "top_menu",
      "label": "Return to Top Menu"
    },
    {
      "source": "lora_rx_handling",
      "target": "face_verify_success",
      "label": "AARI55 (verify) received"
    },
    {
      "source": "lora_rx_handling",
      "target": "face_enroll_success",
      "label": "AARF55 (hard/Do Not Disturb context) received"
    },
    {
      "source": "battery_update_loop",
      "target": "top_menu",
      "label": "Battery status updated"
    },
    {
      "source": "pir_check",
      "target": "do_not_disturb",
      "label": "PIR detected (not silent)"
    },
    {
      "source": "do_not_disturb",
      "target": "top_menu",
      "label": "Any short press exits Do Not Disturb"
    },
    {
      "source": "do_not_disturb",
      "target": "do_not_disturb",
      "label": "PIR motion during silent keeps display blank"
    },
    {
      "source": "top_menu",
      "target": "end",
      "label": "End of flow (idle termination not typical)"
    }
  ]
}